name: E2E Tests

on:
  # Only run on commits to main (docs/md changes are ignored)
  push:
    branches: [main]
    paths-ignore:
    - 'docs/**'
    - '*.md'
  # Run when a new comment is added on PRs (to accept /run-e2e)
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

# Avoid duplicate/parallel E2E runs for the same target
concurrency:
  group: e2e-${{ github.event_name }}-${{ github.ref || github.event.issue.number }}
  cancel-in-progress: true

jobs:
  test-e2e:
    name: Run on Ubuntu

    # Allow only:
    # - push to main
    # - a PR comment containing "/run-e2e" from members/owners/collaborators
    if: >
      github.event_name == 'push' || (
        github.event_name == 'issue_comment' &&
        github.event.issue.pull_request &&
        contains(github.event.comment.body, '/run-e2e') &&
        (
          github.event.comment.author_association == 'MEMBER' ||
          github.event.comment.author_association == 'OWNER'  ||
          github.event.comment.author_association == 'COLLABORATOR'
        )
      )

    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    - name: Determine target ref (PR merge or current)
      id: target
      run: |
        # For a PR comment, test the merge ref for safety.
        # For push, use the current ref.
        if [ "${{ github.event_name }}" = "issue_comment" ]; then
          echo "ref=refs/pull/${{ github.event.issue.number }}/merge" >> "$GITHUB_OUTPUT"
        else
          echo "ref=${{ github.ref }}" >> "$GITHUB_OUTPUT"
        fi

    - name: Clone the code
      uses: actions/checkout@v4
      with:
        ref: ${{ steps.target.outputs.ref }}
        fetch-depth: 0

    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version-file: go.mod
        cache: true
        cache-dependency-path: go.sum

    - name: Install the latest version of kind
      run: |
        # NOTE: pin a specific version for reproducibility if needed
        curl -fsSL -o ./kind https://kind.sigs.k8s.io/dl/latest/kind-linux-amd64
        chmod +x ./kind
        sudo mv ./kind /usr/local/bin/kind

    - name: Verify kind installation
      run: kind version

    - name: Running Test e2e
      id: e2e
      continue-on-error: true
      run: |
        # Keep tidy for parity with local runs (optional)
        go mod tidy
        # Run tests and capture exit code
        set +e
        make test-e2e
        code=$?
        echo "code=${code}" >> "$GITHUB_OUTPUT"
        # Do not fail the job here; we will fail explicitly at the end
        exit 0

    - name: Debug gating values
      if: ${{ always() }}
      run: |
        echo "event_name=${{ github.event_name }}"
        echo "is_pr_comment=$(if [ '${{ github.event_name }}' = 'issue_comment' ]; then echo yes; else echo no; fi)"
        echo "e2e_exit_code=${{ steps.e2e.outputs.code }}"

    - name: Report back to PR
      # Always try to comment back on PR-triggered runs, even if tests failed
      if: ${{ always() && github.event_name == 'issue_comment' }}
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const code = Number("${{ steps.e2e.outputs.code || 1 }}");
          const ok = code === 0;
          const ref = "${{ steps.target.outputs.ref }}";
          const url = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;
          const body = ok
            ? `✅ E2E passed on \`${ref}\` — [view run](${url})`
            : `❌ E2E failed on \`${ref}\` — [view run](${url})`;
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: ${{ github.event.issue.number }},
            body
          });

    - name: Fail job if E2E failed
      if: ${{ steps.e2e.outputs.code != '0' }}
      run: |
        echo "E2E failed with exit code ${{ steps.e2e.outputs.code }}"
        exit 1

